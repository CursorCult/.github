name: mint-rule

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      branch:
        required: true
        type: string
      python-version:
        required: false
        type: string
        default: "3.12"

jobs:
  mint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-test.txt
      - name: Run tests
        run: |
          pytest
      - name: Build clean main snapshot
        run: |
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"
          git checkout --orphan main
          git reset --hard
          git checkout ${{ inputs.branch }} -- .
          rm -rf tests requirements-test.txt .github/workflows/tests.yml .github/workflows/mint.yml
          git add -A
          git commit -m "UNO v${{ inputs.version }}"
          git tag -f v${{ inputs.version }}
      - name: Prepare t0 for verification
        run: |
          git checkout ${{ inputs.branch }}
          git rm -f .github/workflows/mint.yml .github/workflows/tests.yml
          git commit -m "temp: drop mint/tests for verify"
          git checkout main
      - name: Run ccverify
        run: |
          git fetch origin main:refs/remotes/origin/main || true
          cursorcult verify .
      - name: Push main and tag
        run: |
          git push --force origin main
          git push --force origin refs/tags/v${{ inputs.version }}:refs/tags/v${{ inputs.version }}
